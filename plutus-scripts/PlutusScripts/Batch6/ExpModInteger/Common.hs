{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE RecordWildCards #-}
{-# LANGUAGE TemplateHaskell #-}
{-# LANGUAGE ViewPatterns #-}

{- | Simple end-to-end unit tests for the Plutus Core `expModInteger` builtin.
These are adapted from the `plutus-conformance` tests.
-}
module PlutusScripts.Batch6.ExpModInteger.Common (
  mkSimpleExpModIntegerPolicy,
  succeedingSimpleExpModIntegerParams,
  mkExpModIntegerInversePolicy,
  succeedingExpModIntegerInverseParams,
  mkExpModIntegerExponentOnePolicy,
  succeedingExpModIntegerExponentOneParams,
  failingExpModIntegerParams,
)
where

import PlutusTx qualified
import PlutusTx.Builtins qualified as BI
import PlutusTx.Builtins.Internal qualified as BI (unitval)
import PlutusTx.Prelude qualified as P

data SimpleParams = SimpleParams
  { a :: Integer -- Value to be exponentiated
  , e :: Integer -- Exponent
  , m :: Integer -- Modulus
  , result :: Integer -- Expected result, -1 for failing tests
  }
PlutusTx.unstableMakeIsData ''SimpleParams
PlutusTx.makeLift ''SimpleParams

{-# INLINEABLE mkSimpleExpModIntegerPolicy #-}
mkSimpleExpModIntegerPolicy :: [SimpleParams] -> P.BuiltinData -> P.BuiltinUnit
mkSimpleExpModIntegerPolicy l _ctx = go l
 where
  go [] = BI.unitval
  go (SimpleParams{..} : rest) =
    if BI.expModInteger a e m == result
      then go rest
      else P.traceError "mkSimpleExpModIntegerPolicy"

-- Checks that `expModInteger` gives the correct results in typical use.  Some
-- of these are checking cases that were incorrectly handled by the GHC library
-- function: see https://gitlab.haskell.org/ghc/ghc/-/issues/26017)
succeedingSimpleExpModIntegerParams :: [SimpleParams]
succeedingSimpleExpModIntegerParams =
  [ SimpleParams -- m = 1 -> return 0
      101
      99
      1
      0
  , SimpleParams -- m = 1 -> return 0
      12389
      (-9)
      1
      0
  , SimpleParams -- m = 1 -> return 0
      (-8987923471283646712347891237947623467284)
      0
      1
      0
  , SimpleParams -- m = 1 -> return 0
      0
      9
      1
      0
  , SimpleParams -- m = 1 -> return 0
      9
      0
      1
      0
  , SimpleParams -- m = 1 -> return 0
      0
      0
      1
      0
  , SimpleParams -- m > 1 and e = 0 -> return 1
      (-789)
      0
      123
      1
  , SimpleParams -- m > 1 and e = 0 -> return 1
      7
      0
      11
      1
  , SimpleParams -- m > 1 and e = 0 -> return 1
      6716724038975293475892345238945892345
      0
      11
      1
  , SimpleParams -- m > 1 and e = 0 -> return 1
      6716724038975293475892345238945892345
      0
      11000000000000000000000000000001200000000000000000000893
      1
  , SimpleParams -- m > 1 and e = 0 -> return 1
      0
      0
      2123478956273846578234523475237
      1
  , SimpleParams -- m > 1, e = -1, gcd a m = 1 -> succeed
      1
      (-1)
      17
      1
  , SimpleParams -- m > 1, e = -1, gcd a m = 1 -> succeed
      18
      (-1)
      17
      1
  , SimpleParams -- m > 1, e = -1, gcd a m = 1 -> succeed
      (-1719)
      (-1)
      17
      8
  , SimpleParams -- m = 3842610773*16548071329, e = -1, gcd a m = 1 -> succeed
      3842610771
      (-1)
      63587797161187827317
      46828242895014337770
  , SimpleParams -- m = 3842610773*16548071329, e = -1, gcd a m = 1 -> succeed
      1654807132907
      (-1)
      63587797161187827317
      36516505836773408443
  , SimpleParams -- m > 1, e < 0, gcd a m = 1 -> succeed
      1
      (-1134134121)
      17
      1
  , SimpleParams -- m > 1, e < 0, gcd a m = 1 -> succeed
      18
      (-5)
      17
      1
  , SimpleParams -- m > 1, e < 0, gcd a m = 1 -> succeed
      (-1719)
      (-100000000000000000000000000000007)
      17
      15
  , SimpleParams -- m = 3842610773*16548071329, e < 0, gcd a m = 1 -> succeed
      3842610771
      (-777777777777777777777771)
      63587797161187827317
      57441510316368658593
  , SimpleParams -- m = 3842610773*16548071329, e < 0, gcd a m = 1 -> succeed
      1654807132907
      (-18446744073709551616)
      63587797161187827317
      60415552098464659702
  , SimpleParams -- Large inputs: m = 2^255-19
      0
      0
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      1
  , SimpleParams -- Large inputs: m = 2^255-19
      2
      64
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      18446744073709551616
  , SimpleParams -- Large inputs: m = 2^255-19
      2
      (-64)
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      30471602430872683006368077679533309455171990423147718600281005145357771866102
  , SimpleParams -- Large inputs: m = 2^255-19
      295783465278346578267348527836475862348589358937497
      89734578923487957289347527893478952378945268423487234782378423
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      32206691988103784342539609430659656895837532833998353585585601025665197189770
  , SimpleParams -- Large inputs: m = 2^255-19
      (-278903489723894263784627895384582367892349236727346)
      2782346783647862783469234789237848236498238946918723789178293
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      41639481880816845111909653885891797604671528343369469127307248315308458868975
  , SimpleParams -- Large inputs: m = 2^255-19
      11111111111111111111111111111111111111111111111111111111111111111789427389478923
      (-789239427389489234897829734789283974892734897283974897238947234722234)
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      9490012894827172785774821291029803814876173214515365770785362878234508261242
  , SimpleParams -- Large inputs: m = 2^255-19
      (-11111111111111111111111111111111111111111111111111111111111111111789427389478923)
      (-789239427389489234897829734789283974892734897283974897238947234722234)
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      9490012894827172785774821291029803814876173214515365770785362878234508261242
  , SimpleParams -- Large inputs: m = 2^255-19, e = m-1
      0289342903489028349034589023745823457892346934785623452334786341567142314
      57896044618658097711785492504343953926634992332820282019728792003956564819948
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      1
  , SimpleParams -- Large inputs: m = 2^255-19, e = -(m-1)
      99999999999999999999999999999999999999999999999999999999999999999999999999999999999
      (-57896044618658097711785492504343953926634992332820282019728792003956564819948)
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      1
  , SimpleParams -- Large inputs: m = 2^255-19, e = 10000*(m-1)
      0289342903489028349034589023745823457892346934785623452334786341567142314
      578960446186580977117854925043439539266349923328202820197287920039565648199480000
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      1
  , SimpleParams -- Large inputs: m = 2^255-19, e = -10000*(m-1)
      99999999999999999999999999999999999999999999999999999999999999999999999999999999999
      (-578960446186580977117854925043439539266349923328202820197287920039565648199480000)
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      1
  , SimpleParams -- Large inputs: m = 79!
      0
      0
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      1
  , SimpleParams -- Large inputs: m = 79!
      2
      64
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      18446744073709551616
  , SimpleParams -- Large inputs: m = 79!
      295783465278346578267348527836475862348589358937497
      89734578923487957289347527893478952378945268423487234782378423
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      280175799933420074585178470510090012806707950340412289432212739835789837904455835552327022379259130346551828535037673
  , SimpleParams -- Large inputs: m = 79!
      (-278903489723894263784627895384582367892349236727346)
      2782346783647862783469234789237848236498238946918723789178293
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      676608236808522252873008336960453539807071928324507727553824692454236867626155713650291062437090100975669387894718464
  , SimpleParams -- Large inputs: m = 79!
      11111111111111111111111111111111111111111111111111111111111111111789427389478923
      (-789239427389489234897829734789283974892734897283974897238947234722234)
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      226253110172970512032322077499046610917698223745805046643293407253856550947890147970889384902312109044059858650440489
  , SimpleParams -- Large inputs: m = 79!
      (-11111111111111111111111111111111111111111111111111111111111111111789427389478923)
      (-789239427389489234897829734789283974892734897283974897238947234722234)
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      226253110172970512032322077499046610917698223745805046643293407253856550947890147970889384902312109044059858650440489
  , SimpleParams -- Large inputs: m = 79!, e = m-1
      0289342903489028349034589023745823457892346934785623452334786341567142314
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010175999999999999999999
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      799213302676025590986559862430737311371208606877556070099461944686298161515921765132026310527039911779485954640707584
  , SimpleParams -- Large inputs: m = 79!, e = -(m-1, a = 2^255-19)
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      ( -894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010175999999999999999999
      )
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      57896044618658097711785492504343953926634992332820282019728792003956564819949
  , SimpleParams -- Large inputs: m = 79!, e = 10000*(m-1)
      0289342903489028349034589023745823457892346934785623452334786341567142314
      8946182130782975286851441715398316520698082167795719072138680632278379906935018605333618108410101759999999999999999990000
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      126589639180843360572550169437466175160404232405174811173487450267795410776435354182712112924966658652508478689509376
  , SimpleParams -- Large inputs: m = 79!, e = -10000*(m-1), a = 2^255-19
      57896044618658097711785492504343953926634992332820282019728792003956564819949
      ( -8946182130782975286851441715398316520698082167795719072138680632278379906935018605333618108410101759999999999999999990000
      )
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      267938415452876215619736915735930925390188109664796165617656900154039538886782993138509072889964389462027704913000001
  ]

-- Check that expMod a (-e) m * expMod a e m = 1 (mod m)
{-# INLINEABLE mkExpModIntegerInversePolicy #-}
mkExpModIntegerInversePolicy :: [SimpleParams] -> P.BuiltinData -> P.BuiltinUnit
mkExpModIntegerInversePolicy l _ctx = go l
 where
  go [] = BI.unitval
  go (SimpleParams{..} : rest) =
    if BI.modInteger (BI.multiplyInteger (BI.expModInteger a e m) (BI.expModInteger a (-e) m)) m == result
      then go rest
      else P.traceError "mkExpModIntegerInversePolicy"

-- The result is always 1 here
succeedingExpModIntegerInverseParams :: [SimpleParams]
succeedingExpModIntegerInverseParams =
  [ SimpleParams -- m > 1, e = -1, gcd a m = 1 -> compute inverse
      18
      (-1)
      17
      1
  , SimpleParams -- m > 1, e = -1, gcd a m = 1 -> compute inverse
      (-1719)
      (-1)
      17
      1
  , SimpleParams -- m = 3842610773*16548071329, e = -1, gcd a m = 1 -> compute inverse
      3842610771
      (-1)
      63587797161187827317
      1
  , SimpleParams -- m = 3842610773*16548071329, e = -1, gcd a m = 1 -> compute inverse
      1654807132907
      (-1)
      63587797161187827317
      1
  , SimpleParams
      1
      (-1134134121)
      17
      1
  , SimpleParams -- m > 1, e < 0, gcd a m = 1 -> compute inverse power
      18
      (-5)
      17
      1
  , SimpleParams -- m > 1, e < 0, gcd a m = 1 -> compute inverse power
      (-1719)
      (-1000000000000000000000000000000)
      17
      1
  , SimpleParams -- m = 3842610773*16548071329, e < 0, gcd a m = 1 -> compute inverse power
      3842610771
      (-777777777777777777777771)
      63587797161187827317
      1
  , SimpleParams
      1654807132907
      (-18446744073709551616)
      63587797161187827317
      1
  ]

data ExponentOneParams = ExponentOneParams
  { a1 :: Integer
  , m1 :: Integer
  }
PlutusTx.unstableMakeIsData ''ExponentOneParams
PlutusTx.makeLift ''ExponentOneParams

-- m > 1, e = 1 -> return b modulo m
{-# INLINEABLE mkExpModIntegerExponentOnePolicy #-}
mkExpModIntegerExponentOnePolicy :: [ExponentOneParams] -> P.BuiltinData -> P.BuiltinUnit
mkExpModIntegerExponentOnePolicy l _ctx = go l
 where
  go [] = BI.unitval
  go (ExponentOneParams{..} : rest) =
    if BI.expModInteger a1 1 m1 == BI.modInteger a1 m1
      then go rest
      else P.traceError "mkExpModIntegerExponentOnePolicy"

succeedingExpModIntegerExponentOneParams :: [ExponentOneParams]
succeedingExpModIntegerExponentOneParams =
  [ ExponentOneParams 117 1000
  , ExponentOneParams 4123213117 1000
  , ExponentOneParams (-883) 1000
  , ExponentOneParams (-10000000000000000000000000883) 1000
  , ExponentOneParams 0 123321
  , ExponentOneParams 123321123321 123321
  , ExponentOneParams 71893478901378904789123789401789034781278399999 1789345724789527834523495789345
  ]

failingExpModIntegerParams :: [SimpleParams]
failingExpModIntegerParams =
  [ SimpleParams 125 (-83241) (-7) (-1) -- m < 0
  , SimpleParams (-885) 5000000 (-2) (-1) -- m < 0
  , SimpleParams 79123789 34767237 (-99572135136512635615235152) (-1) -- m < 0
  , SimpleParams 0 0 (-1) (-1) -- m = 0
  , SimpleParams 0 0 0 (-1) -- m = 0
  , SimpleParams 5 12 0 (-1) -- m = 0
  , SimpleParams 123234725734785273457322 321 0 (-1) -- m = 0
  , SimpleParams 0 (-1) 17 (-1) -- m > 1, e = (-1), gcd a m > 1
  , SimpleParams 17 (-1) 17 (-1) -- m > 1, e = (-1), gcd a m > 1
  , SimpleParams (-1717) (-1) 17 (-1) -- m > 1, e = (-1), gcd a m > 1
  , SimpleParams 3842610773 (-1) 63587797161187827317 (-1) -- m = 3842610773*16548071329, e = (-1), gcd a m > 1
  , SimpleParams 16548071329 (-1) 63587797161187827317 (-1) -- m = 3842610773*16548071329, e = (-1), gcd a m > 1
  , SimpleParams 0 (-1134134121) 17 (-1) -- m > 1, e < 0, gcd a m > 1
  , SimpleParams 17 (-5) 17 (-1) -- m > 1, e < 0, gcd a m > 1
  , SimpleParams (-1717) (-1000000000000000000000000000000) 17 (-1) -- m > 1, e < 0, gcd a m > 1
  , SimpleParams 3842610773 (-777777777777777777777771) 63587797161187827317 (-1) -- m = 3842610773*16548071329, e < 0, gcd a m > 1
  , SimpleParams 16548071329 (-18446744073709551616) 63587797161187827317 (-1) -- m = 3842610773*16548071329, e < 0, gcd a m > 1
  , SimpleParams
      2
      (-64)
      894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000
      (-1) -- Large inputs: m = 79! (gcd > 1)
  ]
